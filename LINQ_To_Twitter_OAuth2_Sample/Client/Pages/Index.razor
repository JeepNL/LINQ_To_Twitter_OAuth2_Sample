@page "/"
@using System.Text.RegularExpressions
@implements IDisposable
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager NavMan
@inject HttpClient Http

<PageTitle>Index</PageTitle>

<h1>Blazor WASM L2T OAuth 2.0</h1>

@if (l2tBase.UserId == "0")
{
    <div class="mt-2">
        <button class="btn btn-primary" @onclick=TwitterOAuth2>Twitter OAuth2</button>
    </div>
}
else
{
    <EditForm Model="@l2tTweet" OnValidSubmit="@PostTweet">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="col-6 mt-2">
            <small class="text-muted">Put that on your plate!</small>
        </div>
        <div class="row align-items-center">
            <div class="col-6">
                <InputTextAreaCount id="textarea" class="form-control" @bind-Value=l2tTweet.Text />
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary">Tweet</button>
            </div>
        </div>
        <div class="row">
            <div class="col-5">
                <small class="text-muted">Token expires in: @tokenExpiresInMin</small>
            </div>
            <div class="col-1 text-end">
                <small class="text-muted">@(280 - l2tTweet.Text.Length)</small>
            </div>
        </div>
    </EditForm>

    <div class="mt-2">
        @if (!string.IsNullOrEmpty(l2tTweet.TweetId))
        {
            <small class="text-success">Last Tweet ID: @l2tTweet.TweetId</small>
        }
        else if (l2tTweet.TweetId == "-1") // error
        {
            <small class="text-danger">Tweet Error: @l2tTweet.ErrorMessage</small>
        }
    </div>

    <div class="mt-2">
        <button @onclick="RevokeToken" class="btn btn-sm btn-primary">Revoke Token</button>
    </div>

    <div class="mt-2">
        <h2>Your Tweets</h2>
        @foreach (var tweet in l2tTimeline)
        {
            <div class="card text-dark bg-light mb-3" style="max-width: 800px;">
                <div class="row g-0">
                    <div class="col-md-1">
                        &nbsp;&nbsp;<img src="@tweet.ProfileImageUrl" class="mt-2 img-fluid rounded-start">
                    </div>
                    <div class="col-md-11">
                        <div class="card-header py-0"><b>@tweet.Name</b> (<a href="https://twitter.com/@tweet.ScreenName" target="_blank"><i>@@@tweet.ScreenName</i>)</a></div>
                        <div class="card-body py-2">
                            <p class="card-text py-0">@((MarkupString)TweetParser(tweet.Text))</p>

                            <div class="container">
                                <div class="row row-cols-2">

                                    @foreach (var media in tweet.Media)
                                    {
                                        // #TODO Check Photo/Video/AnimGif
                                        // #TODO Different layouts for 1 or 3 image(s)
                                        <div class="col">
                                            @*<img style="width: 300px;height: 150px;object-fit:cover;" src="@media.Url" width="@media.Width" height="@media.Height" alt="@media.AltText" />*@
                                            <a href="@media.Url" target="_blank">
                                                <img class="col img-fluid" style="height:150px;object-fit:cover" src="@media.Url" alt="@media.AltText" width="@media.Width" height="@media.Height" />
                                            </a>
                                        </div>
                                    }

                                </div>
                            </div>

                        </div>
                        <div class="card-footer pl-4 py-0">
                            <small class="text-muted">
                                <a href="#" @onclick="(() => DeleteTweet(tweet))"><span class="oi oi-trash link-danger" aria-hidden="true" /></a>&nbsp;
                                @tweet.TweetDate?.ToLocalTime() -
                                Via: @tweet.Source
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private Timer _timer;
    private L2TBase l2tBase = new();
    private L2TTweet l2tTweet = new();
    private L2TTimelineRequest l2TTimelineRequest = new();
    private List<L2TTimelineResponse> l2tTimeline = new();
    private string tweetText = string.Empty;
    private string tokenExpiresInMin = string.Empty;
    private long lastId = 0;

    private Regex regexAt = new Regex(@"(?<=^|(?<=[^a-zA-Z0-9-_\\.]))@([A-Za-z_]+[A-Za-z0-9_]+)", RegexOptions.IgnoreCase | RegexOptions.Compiled);
    private Regex regexUrl = new Regex(@"", RegexOptions.IgnoreCase | RegexOptions.Compiled);
    private Regex regexHash = new Regex(@"(?<=^|(?<=[^a-zA-Z0-9\\.]))#([A-Za-z]+[A-Za-z0-9]+)", RegexOptions.IgnoreCase | RegexOptions.Compiled);

    //private bool auth = false;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"***** OnInitializedAsync() BEGIN");

        l2tBase = await localStorage.GetItemAsync<L2TBase>("l2t_base");
        if (l2tBase is not null && !string.IsNullOrEmpty(l2tBase.AccessToken) && !string.IsNullOrEmpty(l2tBase.RefreshToken))
        {
            //Console.WriteLine($"***** OnInitializedAsync() - auth = true;");
            //auth = true;
            Console.WriteLine($"***** OnInitializedAsync() - Call StartTimer();");
            StartTimer();

            // #TODO if refreshtoken expires < 0 => refreshtokem
            await UserTimeline();
        }
        else
            await localStorage.SetItemAsync<L2TBase>("l2t_base", l2tBase = new());

        Console.WriteLine($"***** OnInitializedAsync() END");
    }

    public async Task DeleteTweet(L2TTimelineResponse tweet)
    {
        if (tweet.AuthorId == l2tBase.UserId)
        {
            L2TTweet deleteTweet = new()
                {
                    Text = tweet.Text, // required field: L2TTweet.cs
                    TweetId = tweet.TweetId,
                    AuthorId = tweet.AuthorId,
                    AccessToken = l2tBase.AccessToken,
                    RefreshToken = l2tBase.RefreshToken,
                };

            HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("Tweet/Delete", deleteTweet);
            if (responseMessage.IsSuccessStatusCode)
            {
                var tweetToRemove = l2tTimeline.Single(r => r.TweetId == tweet.TweetId);
                l2tTimeline.Remove(tweetToRemove);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task PostTweet()
    {
        l2tTweet.AccessToken = l2tBase.AccessToken;
        l2tTweet.RefreshToken = l2tBase.RefreshToken;

        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("Tweet/Post", l2tTweet);
        l2tTweet = await responseMessage.Content.ReadFromJsonAsync<L2TTweet>(); // l2tTweet is never null

        if (responseMessage.IsSuccessStatusCode)
        {
            l2tTweet.Text = string.Empty;
            l2tTweet.ErrorMessage = string.Empty;
        }
    }

    private async Task UserTimeline()
    {
        Console.WriteLine($"***** UserTimeline() - BEGIN");
        l2TTimelineRequest.AccessToken = l2tBase.AccessToken;
        l2TTimelineRequest.RefreshToken = l2tBase.RefreshToken;
        l2TTimelineRequest.ForUserId = l2tBase.UserId;
        l2TTimelineRequest.ForScreenName = ""; // #TODO
        l2TTimelineRequest.Filter = ""; // #TODO
        l2TTimelineRequest.MaxResults = 25;
        l2TTimelineRequest.SinceId = lastId;

        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("TL/UserTimeline", l2TTimelineRequest);

        if (responseMessage.IsSuccessStatusCode)
            l2tTimeline = await responseMessage.Content.ReadFromJsonAsync<List<L2TTimelineResponse>>();

        foreach (var tweet in l2tTimeline)
            if (tweet.Urls is not null)
                foreach (var url in tweet.Urls)
                    if (url.DisplayUrl.StartsWith("pic.twitter.com/"))
                        tweet.Text = tweet.Text.Replace(url.Url, string.Empty);
                    else
                        tweet.Text = tweet.Text.Replace(url.Url, $"<a href=\"{url.ExpandedUrl}\">{url.DisplayUrl}</a>");

        Console.WriteLine($"***** UserTimeline() - END");
    }

    private void TwitterOAuth2()
    {
        // 'true' as a second parameter (optional, default = false) means the page will refresh, like a F5.
        // "/OAuth2/Begin" is the route to the OAuth2 controller on the server which redirects the user to
        // the Twitter authorization page. After that the server controller redirects to
        // "/Pages/Callback.razor" (/l2tcallback) on the client which will load the Blazor WASM site again.
        NavMan.NavigateTo("/OAuth2/Begin", true);
    }

    public async Task RefreshToken()
    {
        // #TODO CHECK IF REFRESHTOKEN IS VALID

        Console.WriteLine($"***** RefreshToken() - BEGIN");

        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/RefreshToken", l2tBase);
        L2TRefreshResponse refreshResponse = await responseMessage.Content.ReadFromJsonAsync<L2TRefreshResponse>();

        l2tBase.AccessToken = refreshResponse.access_token;
        l2tBase.RefreshToken = refreshResponse.refresh_token;
        l2tBase.ExpireTokenTicks = DateTime.UtcNow.AddSeconds(refreshResponse.expires_in).Ticks;

        await localStorage.SetItemAsync<L2TBase>("l2t_base", l2tBase);
        tokenExpiresInMin = "120";
    }

    public async Task RevokeToken()
    {
        await Http.PostAsJsonAsync("OAuth2/RevokeToken", l2tBase);
        //HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/RevokeToken", l2tBase);
        //status = responseMessage.Content.ToString();

        l2tBase.UserId = "0";
        l2tBase.AccessToken = string.Empty;
        l2tBase.RefreshToken = string.Empty;
        l2tBase.ExpireTokenTicks = 0;

        await localStorage.SetItemAsync<L2TBase>("l2t_base", l2tBase);
    }

    // updates tokenExpiresInMin every minute
    public void StartTimer()
    {
        Console.WriteLine($"***** StartTimer() - BEGIN");
        _timer = new Timer(async _ =>
        {
            long ticksLeft = l2tBase.ExpireTokenTicks - DateTime.UtcNow.Ticks;
            TimeSpan expires = new TimeSpan(ticksLeft);

            if (expires.TotalMinutes < 5)
            {
                Console.WriteLine($"***** StartTimer() - await RefreshToken();");
                await RefreshToken();
            }
            else
                tokenExpiresInMin = expires.TotalMinutes.ToString(format: "N0") + " minutes.";

            Console.WriteLine($"***** StartTimer() - await InvokeAsync(StateHasChanged); ");
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000 * 60); // 1000ms * 60 = 1 minute

        Console.WriteLine($"***** StartTimer() - END");
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    // utilities

    public string TweetParser(string tweetText) // #TODO #INPROGRESS
    {
        //Console.WriteLine($"1: {s}");

        //@ and #
        tweetText = regexAt.Replace(tweetText, @"<a href=""https://twitter.com/$0"" target=""_blank"">$0</a>");
        tweetText = regexHash.Replace(tweetText, @$"<a href=""https://twitter.com/search?q=$0"" target=""_blank"">$0</a>");

        // https://twitter.com/search?q=%23hash
        // https://twitter.com/hashtag/Test2
        tweetText = tweetText.Replace("?q=#", "?q=%23");
        return tweetText;
    }

    //Console.WriteLine($"***** : {}");
}
