@page "/"
@implements IDisposable
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager NavMan
@inject HttpClient Http

<PageTitle>Index</PageTitle>

<h1>Hello, Twitter!</h1>

@* #TODO 'Me' endpoint, Welcome, screenName! *@

@if (l2tTokens.ExpireTokenTicks == 0)
{
    <p><button class="btn btn-primary" @onclick=BeginOAuth2>Twitter OAuth2</button></p>
}
else if (!string.IsNullOrEmpty(l2tUser.Id))
{
    <div>
        <p>
            ID: @l2tUser.Id
            <br />Handle: @l2tUser.Handle
            <br />Name: @l2tUser.Name
        </p>
    </div>

    <EditForm Model="@l2tTweet" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="col-6">
            <small class="text-muted">Put that on your plate!</small>
        </div>
        <div class="row align-items-center">
            <div class="col-6">
                <InputTextAreaCount id="textarea" class="form-control" @bind-Value=l2tTweet.Text />
            </div>
            <div class="col-2">
                <button type="submit" class="btn btn-sm btn-primary">Tweet</button>
            </div>
        </div>
        <div class="row">
            <div class="col-5">
                <small class="text-muted">Token expires in: @tokenExpiresInMin</small>
            </div>
            <div class="col-1 text-end">
                <small class="text-muted">@(280 - l2tTweet.Text.Length)</small>
            </div>

        </div>
    </EditForm>

    <br />

    @if (l2tTweet?.TweetId != "0")
    {
        <div>
            <small class="text-success">Last Tweet ID: @l2tTweet?.TweetId</small>
        </div>
    }

    @if (!string.IsNullOrEmpty(l2tTweet?.Error))
    {
        <div>
            <small class="text-danger">Tweet Error: @l2tTweet.Error</small>
        </div>
    }

    <br />

    <div>
        <p>
            <i>Just for testing:</i><br />
            <button @onclick="RefreshToken" class="btn btn-sm btn-primary">Refresh Token</button>
            &nbsp;<button @onclick="RevokeToken" class="btn btn-sm btn-primary">Revoke Token</button>
        </p>
    </div>
}

@code {
    private Timer _timer;
    private L2TBase l2tTokens = new();
    private L2TUser l2tUser = new();
    private L2TTweet l2tTweet;
    private string tweetText = string.Empty;
    private string tokenExpiresInMin = string.Empty;
    private string status = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        l2tTokens = await localStorage.GetItemAsync<L2TBase>("l2t_tokens");

        if (l2tTokens is null)
            await localStorage.SetItemAsync<L2TBase>("l2t_tokens", l2tTokens = new());
        else if (l2tTokens.ExpireTokenTicks > 0)
        {
            await UserInfo();
            StartTimer();
        }

        l2tTweet = new() // init tweet
            {
                AccessToken = l2tTokens.AccessToken,
                RefreshToken = l2tTokens.RefreshToken,
                ExpireTokenTicks = l2tTokens.ExpireTokenTicks,
                Text = string.Empty,
                TweetId = "0",
                Error = string.Empty
            };
    }

    private void BeginOAuth2()
    {
        // 'true' as a second parameter (optional, default = false) means the page will refresh, like a F5.
        // "/OAuth2/Begin" is the route to the OAuth2 controller on the server which redirects the user to
        // the Twitter authorization page. After that the server controller redirects to
        // "/Pages/Callback.razor" (/l2tcallback) on the client which will load the Blazor WASM site again.
        NavMan.NavigateTo("/OAuth2/Begin", true);
    }

    // updates tokenExpiresInMin every minute
    public void StartTimer()
    {
        _timer = new Timer(async _ =>
        {
            long ticksLeft = l2tTokens.ExpireTokenTicks - DateTime.UtcNow.Ticks;
            TimeSpan expires = new TimeSpan(ticksLeft);
            double expiresInMin = Math.Round(expires.TotalMinutes, 2);

            switch (expiresInMin)
            {
                case <= 0:
                    tokenExpiresInMin = "expired.";
                // #TODO RefreshToken
                break;
                case double x when x > 0 && x < 2:
                    tokenExpiresInMin = "one minute."; // +/- :)
                break;
                default:
                    tokenExpiresInMin = expires.TotalMinutes.ToString(format: "N0") + " minutes.";
                    break;
            }

            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000 * 60); // 1000ms * 60 = 1 minute
    }

    private async Task UserInfo()
    {
        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/UserInfo", l2tTokens);
        l2tUser = await responseMessage.Content.ReadFromJsonAsync<L2TUser>();
    }

    private async Task HandleValidSubmit()
    {
        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/PostTweet", l2tTweet);
        l2tTweet = await responseMessage.Content.ReadFromJsonAsync<L2TTweet>(); // l2tTweet is never null

        if (l2tTweet.TweetId != "-1") // -1 = catch error - #TODO enum
        {
            l2tTweet.Text = string.Empty;
            l2tTweet.Error = string.Empty;
        }
    }

    public async Task RefreshToken()
    {
        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/RefreshToken", l2tTokens);
        L2TRefreshResponse refreshResponse = await responseMessage.Content.ReadFromJsonAsync<L2TRefreshResponse>();

        l2tTokens.AccessToken = refreshResponse.access_token;
        l2tTokens.RefreshToken = refreshResponse.refresh_token;
        l2tTokens.ExpireTokenTicks = DateTime.UtcNow.AddSeconds(refreshResponse.expires_in).Ticks;
        await localStorage.SetItemAsync<L2TBase>("l2t_tokens", l2tTokens);
    }

    public async Task RevokeToken()
    {
        HttpResponseMessage responseMessage = await Http.PostAsJsonAsync("OAuth2/RevokeToken", l2tTokens);
        status = responseMessage.Content.ToString();

        l2tUser.Id = string.Empty;
        l2tTokens.AccessToken = string.Empty;
        l2tTokens.RefreshToken = string.Empty;
        l2tTokens.ExpireTokenTicks = 0;
        await localStorage.SetItemAsync<L2TBase>("l2t_tokens", l2tTokens);
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
